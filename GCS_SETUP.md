# Google Cloud Storage Setup Guide

Complete guide to set up Google Cloud Storage (GCS) for NV Video Clipper.

## üè¢ Organization vs Personal Accounts

**Organization Account?** Some options will be different:
- ‚úÖ Access control will be "Uniform (Private)" instead of "Fine-grained"
- ‚úÖ This is actually better for security!
- ‚úÖ Everything still works perfectly - signed URLs provide temporary access
- ‚úÖ Service account handles all permissions via IAM roles

**Personal Account?**
- ‚úÖ You'll see "Fine-grained" access control option
- ‚úÖ Either option works great

Both account types work identically for this app - no code changes needed!

## üìä Free Tier Benefits

- ‚úÖ **5 GB** storage free per month
- ‚úÖ **5,000 Class A operations** (PUT, COPY, POST, LIST) per month
- ‚úÖ **50,000 Class B operations** (GET, HEAD) per month
- ‚úÖ **1 GB egress** to North America per month
- ‚úÖ **Always free** (not just a trial)

For video clipper development: **$0/month**

---

## Part 1: Google Cloud Setup (10 minutes)

### Step 1: Create Google Cloud Account

1. Go to: **https://console.cloud.google.com**
2. Sign in with your Google account
3. Accept the terms of service

**Note:** You may be asked for a credit card for verification, but you won't be charged if you stay within free tier limits.

### Step 2: Create a New Project

1. Click the project dropdown at the top (says "Select a project")
2. Click **"NEW PROJECT"**
3. Enter project details:
   - **Project name**: `nv-video-clipper`
   - **Organization**: Leave as "No organization"
4. Click **"CREATE"**
5. Wait for project creation (~30 seconds)
6. Select your new project from the dropdown

### Step 3: Enable Cloud Storage API

1. In the search bar at top, type: **"Cloud Storage API"**
2. Click **"Cloud Storage API"**
3. Click **"ENABLE"**
4. Wait for activation (~1 minute)

### Step 4: Create Storage Bucket

1. In the left menu, go to **"Cloud Storage" ‚Üí "Buckets"**
   - Or search for "Storage" in the top search bar
2. Click **"CREATE BUCKET"**

3. **Step 1 - Name your bucket:**
   - Bucket name: `nv-video-clipper-YOURNAME` (must be globally unique)
   - Example: `nv-video-clipper-john123`
   - Note: Use lowercase, numbers, hyphens only
   - Click **"CONTINUE"**

4. **Step 2 - Choose where to store your data:**
   - Location type: **Region** (cheapest)
   - Region: Choose closest to you (e.g., `us-east1`, `us-west1`)
   - Click **"CONTINUE"**

5. **Step 3 - Choose a storage class:**
   - Default class: **Standard**
   - Click **"CONTINUE"**

6. **Step 4 - Control access to objects:**
   - Uncheck "Enforce public access prevention" (if available)
   - Access control: 
     - **Personal accounts**: Choose "Fine-grained" (allows individual object permissions)
     - **Organization accounts**: Choose "Uniform" (Private access) - this is the only option available
     
   **Note:** Both options work perfectly! With Uniform access, your service account will still have full access via the "Storage Object Admin" role.
   
   - Click **"CONTINUE"**

7. **Step 5 - Protect object data:**
   - Leave defaults (no encryption key needed)
   - Click **"CREATE"**

### Step 5: Configure CORS (Required for Browser Uploads)

**Important:** CORS configuration allows your browser to upload files directly to GCS.

1. Click on your bucket name in the list
2. Go to the **"Configuration"** tab
3. Scroll down to **"CORS configuration"**
4. Click **"EDIT"** (or **"SET CORS CONFIGURATION"** if it says "No CORS configuration")
5. If there's an existing configuration, you can replace it
6. Paste this JSON configuration:

```json
[
  {
    "origin": ["http://localhost:3000", "http://localhost:3001"],
    "method": ["GET", "POST", "PUT"],
    "responseHeader": ["Content-Type", "Content-Length", "ETag"],
    "maxAgeSeconds": 3600
  }
]
```

7. Click **"SAVE"**

**Note for Organization Accounts:**
- If you're using Uniform (private) access, CORS still works the same way
- The service account you create in the next step will handle authentication
- Signed URLs (generated by the app) provide temporary access for uploads/downloads

### Step 6: Create Service Account

1. In the left menu, go to **"IAM & Admin" ‚Üí "Service Accounts"**
   - Or search "Service Accounts" in top search bar
2. Click **"CREATE SERVICE ACCOUNT"**

3. **Service account details:**
   - Service account name: `nv-video-clipper-sa`
   - Service account ID: (auto-filled)
   - Description: "Service account for video clipper app"
   - Click **"CREATE AND CONTINUE"**

4. **Grant this service account access:**
   - Role: Search for **"Storage Object Admin"**
   - Click **"CONTINUE"**

5. **Grant users access:** (optional)
   - Skip this step
   - Click **"DONE"**

### Step 7: Create Service Account Key

1. Click on the service account you just created
2. Go to the **"KEYS"** tab
3. Click **"ADD KEY" ‚Üí "Create new key"**
4. Key type: **JSON**
5. Click **"CREATE"**

A JSON file will download automatically. **SAVE THIS FILE!**

**‚ö†Ô∏è Troubleshooting for Organization Accounts:**

If you **cannot create or download the key**:

**Issue**: Organization policy may restrict service account key creation

**Solutions**:

**A) Request Permission from Org Admin:**
- Contact your organization administrator
- Request: "Service Account Key Admin" role
- Or ask them to create the key for you

**B) Use Workload Identity Federation (Advanced):**
- For production deployments (skip for local development)

**C) Use Application Default Credentials (Local Development - EASIEST):**
- This method works for local testing without downloading keys
- See "Alternative: Application Default Credentials" section below

It looks like:
```json
{
  "type": "service_account",
  "project_id": "nv-video-clipper",
  "private_key_id": "abc123...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...",
  "client_email": "nv-video-clipper-sa@...",
  "client_id": "...",
  ...
}
```

**IMPORTANT:** Keep this file secure! It grants full access to your bucket.

---

## Alternative: Application Default Credentials (No Key Download Needed!)

**Can't download a service account key?** Use this method instead:

This approach uses **your own Google account credentials** for local development - perfect when organization policies block key creation.

### Step 1: Install Google Cloud CLI

```bash
# Check if already installed
gcloud --version

# If not installed:
brew install google-cloud-sdk
```

### Step 2: Authenticate with Your Google Account

```bash
gcloud auth application-default login
```

This will:
- Open your browser
- Ask you to sign in with your Google account
- Save credentials locally (no JSON file needed!)

### Step 3: Set Your Project

```bash
gcloud config set project YOUR_PROJECT_ID
```

Replace `YOUR_PROJECT_ID` with your actual project ID (e.g., `nv-video-clipper-michal`)

### Step 4: Grant Yourself Storage Admin Role

You need to give your own account permission to access the bucket:

```bash
gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
    --member="user:YOUR_EMAIL@gmail.com" \
    --role="roles/storage.objectAdmin"
```

Replace:
- `YOUR_PROJECT_ID` with your project ID
- `YOUR_EMAIL@gmail.com` with your Google account email

### Step 5: Update .env Files

**Instead of pointing to a JSON file**, leave the credentials path empty:

Edit `.env`:
```env
# Google Cloud Storage Configuration
GCS_PROJECT_ID=your-project-id
GCS_BUCKET_NAME=nv-video-clipper-yourname
# GCS_CREDENTIALS_PATH=  (leave this commented out or empty)

# Rest of config...
```

Edit `worker/.env` the same way.

### Step 6: Update Code to Use Default Credentials

The Google Cloud Storage library will automatically use your authenticated credentials!

---

## Part 2: Configure Application

### Step 1: Move Service Account Key

Move the downloaded JSON file to your project:

```bash
cd "/Users/mpechardo/Desktop/NVIDIA/NV Video Clipper"
mv ~/Downloads/nv-video-clipper-*.json ./gcs-credentials.json
```

Make sure it's in `.gitignore` (it already is).

### Step 2: Install GCS Client Library

```bash
# In main project
npm install @google-cloud/storage

# In worker
cd worker
npm install @google-cloud/storage
cd ..
```

### Step 3: Update Environment Variables

Edit `.env` in the root directory:

```env
# Google Cloud Storage Configuration
GCS_PROJECT_ID=nv-video-clipper
GCS_BUCKET_NAME=nv-video-clipper-yourname
GCS_CREDENTIALS_PATH=./gcs-credentials.json

# Upstash Redis Configuration (still needed for job queue)
UPSTASH_REDIS_REST_URL=https://placeholder.upstash.io
UPSTASH_REDIS_REST_TOKEN=placeholder_token

# Next.js
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

Edit `worker/.env`:

```env
# Google Cloud Storage Configuration
GCS_PROJECT_ID=nv-video-clipper
GCS_BUCKET_NAME=nv-video-clipper-yourname
GCS_CREDENTIALS_PATH=../gcs-credentials.json

# Upstash Redis Configuration
UPSTASH_REDIS_REST_URL=https://placeholder.upstash.io
UPSTASH_REDIS_REST_TOKEN=placeholder_token
```

**Note:** We still need Redis for the job queue. You can:
- Use **Upstash Redis** (free tier: 10K commands/day)
- Or I can implement local SQLite storage instead

---

## Part 3: Update Code for GCS

I'll update the code files to use Google Cloud Storage instead of R2.

The main changes are in:
- `src/lib/storage.ts` (new file)
- `src/app/api/storage/upload-url/route.ts` (updated)
- `worker/src/storage.ts` (new file)

---

## Part 4: Start the Application

### Terminal 1: Main App
```bash
npm run dev
```

### Terminal 2: Worker
```bash
cd worker
npm run dev
```

### Terminal 3: Upstash Redis Setup (if needed)

If you don't have Redis yet:

**Option A: Use Upstash Redis (Easy, Free)**
1. Go to: https://console.upstash.com
2. Create database: `nv-video-clipper`
3. Copy REST URL and token to `.env` files

**Option B: Use Local SQLite**
- Let me know and I'll implement this instead

---

## Part 5: Test Everything

1. Open: **http://localhost:3000**
2. Yellow "Demo Mode" banner should be **GONE**
3. Upload a video (will go to GCS)
4. Trim it (3-6 seconds)
5. Export (worker processes from GCS)
6. Download your clip!

---

## Troubleshooting

### "Could not load the default credentials"
- Check that `gcs-credentials.json` exists in project root
- Check `GCS_CREDENTIALS_PATH` in `.env` is correct
- Restart the server after adding credentials

### "Permission denied" errors
- Ensure service account has "Storage Object Admin" role
- Check bucket name in `.env` matches exactly
- For organization accounts with Uniform access: This is normal and expected - permissions are managed through IAM roles, which you've already set up

### "CORS error" in browser
- Make sure CORS is configured in bucket settings
- Add your localhost URL to allowed origins

### Worker can't download files
- Check worker's `GCS_CREDENTIALS_PATH` points to `../gcs-credentials.json`
- Ensure service account has read permissions

---

## Cost Monitoring

To check your usage:

1. Go to: **Cloud Console ‚Üí Billing ‚Üí Reports**
2. Filter by: Cloud Storage
3. View: Current month usage

With the free tier, you should see **$0** charges for development.

---

## Security Best Practices

1. **Never commit** `gcs-credentials.json` to git
2. **Rotate keys** every 90 days (delete old, create new)
3. **Limit permissions** - only Storage Object Admin needed
4. **Enable billing alerts** in Cloud Console

---

## Next Steps

Once working locally:

1. **Deploy Frontend** to Vercel
   - Add `gcs-credentials.json` content as environment variable
   - Or use Vercel's secret management

2. **Deploy Worker** to Cloud Run
   - Include credentials in container
   - Or use GCP's built-in service account auth

3. **Update CORS** to include production URLs

---

## Comparison: R2 vs GCS

| Feature | Cloudflare R2 | Google Cloud Storage |
|---------|---------------|----------------------|
| Free Storage | 10 GB | 5 GB |
| Free Operations | 1M/month | 5K writes, 50K reads/month |
| Egress Fees | $0 | $0.12/GB (after 1GB) |
| Setup Time | 10 min | 15 min |
| Credit Card | No | Yes (verification) |

Both are great options! GCS has better integration with other Google services.

---

**Ready?** Let me know when you have:
1. ‚úÖ GCS bucket created
2. ‚úÖ Service account JSON downloaded
3. ‚úÖ Credentials moved to project folder

Then I'll update the code to use GCS! üöÄ
